# üöÄ Complete Production Deployment Guide

## Shad Coding Task1 - AWS Ubuntu Server Deployment

**Target Server**: AWS Ubuntu 20.04/22.04 LTS
**Server IP**: 18.217.70.110
**Domain**: zohaib.no (optional)
**Deployment**: HTTP (Nginx + Gunicorn)

---

## üìã Table of Contents

1. [Pre-Deployment Checklist](#pre-deployment-checklist)
2. [Initial Server Setup](#initial-server-setup)
3. [Deployment Execution](#deployment-execution)
4. [Post-Deployment Verification](#post-deployment-verification)
5. [Troubleshooting](#troubleshooting)
6. [Maintenance Commands](#maintenance-commands)

---

## ‚úÖ Pre-Deployment Checklist

Before starting, ensure you have:

- [ ] AWS server running (Ubuntu 20.04/22.04)
- [ ] SSH access to server (`ssh ubuntu@18.217.70.110`)
- [ ] Server allows incoming traffic on ports:
  - Port 22 (SSH)
  - Port 80 (HTTP)
- [ ] GitHub repository is up to date
- [ ] Statens Vegvesen API key ready
- [ ] Local code is pushed to GitHub `main` branch

### Verify Your Code is Ready

```bash
# On your local machine
git status                    # Should show "nothing to commit, working tree clean"
git branch                    # Should show you're on 'main' branch
git log --online -1           # Should show your latest commit
```

---

## üîß Initial Server Setup (One-Time Only)

This section is for **first-time deployment only**. If you've already set up the server, skip to [Deployment Execution](#deployment-execution).

### Step 1: Connect to Your Server

```bash
ssh ubuntu@18.217.70.110
```

If prompted, type `yes` to accept the SSH fingerprint.

### Step 2: Clone Your Repository

```bash
# Clone your repository
git clone https://github.com/zahaibalig/shadcoding-task1.git

# Navigate to project directory
cd shadcoding-task1
```

### Step 3: Run the Setup Script

```bash
# Make sure you're in the project root
pwd    # Should show: /home/ubuntu/shadcoding-task1

# Run the setup script as root
sudo bash deployment/setup_server.sh
```

**What this script does:**
1. Updates system packages
2. Installs Python 3.11, Node.js 20, Nginx
3. Creates `deploy` user
4. Sets up Python virtual environment
5. Installs all dependencies
6. Generates random Django `SECRET_KEY`
7. Runs Django migrations
8. Builds Vue.js frontend
9. Configures and starts services
10. Sets up UFW firewall

**Duration**: 5-10 minutes

### Step 4: Create Django Superuser

When prompted during setup, create a superuser:

```
Username: admin
Email address: your@email.com
Password: ********
Password (again): ********
```

**Or create later:**
```bash
sudo -u deploy bash -c "cd /home/deploy/shadcoding-task1/backend && source ../venv/bin/activate && python manage.py createsuperuser"
```

### Step 5: Configure Environment Variables

Edit the `.env` file with your actual values:

```bash
sudo nano /home/deploy/shadcoding-task1/backend/.env
```

**Required changes:**
```bash
# Your actual API key
STATENS_VEGVESEN_API_KEY=your-actual-api-key-here

# Already generated (can leave as is)
SECRET_KEY=<auto-generated-key>

# Production settings (already correct)
DEBUG=False
ALLOWED_HOSTS=18.217.70.110,zohaib.no,www.zohaib.no,localhost,127.0.0.1
```

**Save and exit**: Press `Ctrl+X`, then `Y`, then `Enter`

### Step 6: Restart Services

```bash
sudo systemctl restart gunicorn
sudo systemctl restart nginx
```

### Step 7: Verify Installation

```bash
# Check service status
sudo systemctl status gunicorn
sudo systemctl status nginx

# Both should show "active (running)" in green
```

---

## üöÄ Deployment Execution (For Updates)

Use this section whenever you need to deploy code changes.

### Step 1: Push Your Code to GitHub

```bash
# On your local machine
git add .
git commit -m "Your commit message"
git push origin main
```

### Step 2: SSH to Server

```bash
ssh ubuntu@18.217.70.110
```

### Step 3: Switch to Deploy User

```bash
sudo su - deploy
```

You should see your prompt change to: `deploy@<hostname>:~$`

### Step 4: Navigate to Project Directory

```bash
cd ~/shadcoding-task1
```

### Step 5: Run Deployment Script

```bash
bash deployment/deploy.sh
```

**What this script does:**
1. ‚úÖ Pulls latest code from GitHub
2. ‚úÖ Updates Python dependencies
3. ‚úÖ Updates frontend API URL to production
4. ‚úÖ Builds Vue.js frontend
5. ‚úÖ Runs Django migrations
6. ‚úÖ Collects Django static files
7. ‚úÖ Copies frontend to Nginx directory
8. ‚úÖ Restarts Gunicorn
9. ‚úÖ Reloads Nginx

**Duration**: 2-5 minutes

### Step 6: Exit Deploy User

```bash
exit
```

You should be back to `ubuntu@<hostname>:~$`

---

## ‚úîÔ∏è Post-Deployment Verification

### 1. Check Services Are Running

```bash
sudo systemctl status gunicorn nginx
```

**Expected output:**
- Both services show `‚óè gunicorn.service` and `‚óè nginx.service`
- Both show `Active: active (running)` in green
- Recent log entries should not show errors

### 2. Test Your Application

Open your web browser and visit:

**Frontend:**
```
http://18.217.70.110
```

**Expected**: You should see your Vue.js landing page

**Django Admin:**
```
http://18.217.70.110/admin/
```

**Expected**: Django admin login page

**API Endpoints:**
```
http://18.217.70.110/api/projects/
```

**Expected**: JSON response with projects list (or empty array `[]`)

### 3. Test API Functionality

**Test GET:**
```bash
curl http://18.217.70.110/api/projects/
```

**Expected**: JSON array

**Test Vehicle Lookup:**
```bash
curl "http://18.217.70.110/api/vehicles/lookup/?registration=ABC123"
```

**Expected**: Vehicle data or error message

### 4. Check Logs (if something doesn't work)

```bash
# Gunicorn logs
sudo journalctl -u gunicorn -n 50

# Nginx error log
sudo tail -20 /var/log/nginx/shadcoding_error.log

# Nginx access log
sudo tail -20 /var/log/nginx/shadcoding_access.log
```

---

## üêõ Troubleshooting

### Issue 1: "502 Bad Gateway"

**Symptoms:** Nginx shows 502 error when accessing site

**Cause:** Gunicorn is not running

**Solution:**
```bash
# Check if Gunicorn is running
sudo systemctl status gunicorn

# If not running, start it
sudo systemctl start gunicorn

# Check logs for errors
sudo journalctl -u gunicorn -n 100

# If errors persist, check .env file
sudo nano /home/deploy/shadcoding-task1/backend/.env
```

### Issue 2: Frontend Shows Blank Page

**Symptoms:** Browser shows white page or 404

**Cause:** Frontend not built or not copied to Nginx directory

**Solution:**
```bash
# Check if frontend files exist
ls -la /var/www/shadcoding/frontend/

# If empty, rebuild frontend
sudo su - deploy
cd ~/shadcoding-task1/frontend
npm run build
sudo cp -r dist/* /var/www/shadcoding/frontend/
sudo chown -R www-data:www-data /var/www/shadcoding
exit

# Reload Nginx
sudo systemctl reload nginx
```

### Issue 3: API Returns 500 Error

**Symptoms:** API calls return Internal Server Error

**Cause:** Database or Django configuration issue

**Solution:**
```bash
# Check if migrations are applied
sudo su - deploy
cd ~/shadcoding-task1/backend
source ../venv/bin/activate
python manage.py showmigrations

# If any migrations not applied
python manage.py migrate

exit

# Restart Gunicorn
sudo systemctl restart gunicorn
```

### Issue 4: "Permission Denied" Errors

**Symptoms:** Deployment script fails with permission errors

**Cause:** File ownership incorrect

**Solution:**
```bash
# Fix ownership
sudo chown -R deploy:deploy /home/deploy/shadcoding-task1
sudo chown -R www-data:www-data /var/www/shadcoding
sudo chown -R deploy:deploy /var/log/gunicorn

# Try deployment again
sudo su - deploy
cd ~/shadcoding-task1
bash deployment/deploy.sh
```

### Issue 5: Frontend Can't Connect to API

**Symptoms:** Frontend loads but API calls fail

**Cause:** Frontend API URL not updated

**Solution:**
```bash
# Check frontend API URL
cat /var/www/shadcoding/frontend/assets/*.js | grep "localhost:8000"

# If found, rebuild frontend
sudo su - deploy
cd ~/shadcoding-task1/frontend

# Update API URL
sed -i "s|http://localhost:8000/api|http://18.217.70.110/api|g" src/services/api.ts

# Rebuild
npm run build
sudo cp -r dist/* /var/www/shadcoding/frontend/
exit
```

### Issue 6: Firewall Blocking Connections

**Symptoms:** Can't connect to site from browser

**Cause:** UFW firewall blocking HTTP

**Solution:**
```bash
# Check firewall status
sudo ufw status

# Allow HTTP if blocked
sudo ufw allow 'Nginx HTTP'

# Reload firewall
sudo ufw reload
```

---

## üîß Maintenance Commands

### Service Management

```bash
# Check service status
sudo systemctl status gunicorn
sudo systemctl status nginx

# Start services
sudo systemctl start gunicorn nginx

# Stop services
sudo systemctl stop gunicorn nginx

# Restart services (full stop/start)
sudo systemctl restart gunicorn nginx

# Reload services (no downtime)
sudo systemctl reload gunicorn nginx

# Enable auto-start on boot
sudo systemctl enable gunicorn nginx

# Disable auto-start on boot
sudo systemctl disable gunicorn nginx
```

### View Logs

```bash
# Gunicorn logs (real-time)
sudo journalctl -u gunicorn -f

# Gunicorn logs (last 100 lines)
sudo journalctl -u gunicorn -n 100

# Gunicorn logs (since today)
sudo journalctl -u gunicorn --since today

# Gunicorn error log
sudo tail -f /var/log/gunicorn/error.log

# Gunicorn access log
sudo tail -f /var/log/gunicorn/access.log

# Nginx error log
sudo tail -f /var/log/nginx/shadcoding_error.log

# Nginx access log
sudo tail -f /var/log/nginx/shadcoding_access.log
```

### Django Management Commands

```bash
# All Django commands must be run as deploy user
sudo su - deploy
cd ~/shadcoding-task1/backend
source ../venv/bin/activate

# Create superuser
python manage.py createsuperuser

# Run migrations
python manage.py migrate

# Show migration status
python manage.py showmigrations

# Collect static files
python manage.py collectstatic --noinput

# Django shell
python manage.py shell

# Check Django configuration
python manage.py check

# Exit deploy user
exit
```

### Database Operations

```bash
# Backup database
sudo cp /home/deploy/shadcoding-task1/backend/db.sqlite3 \
       ~/backups/db_$(date +%Y%m%d_%H%M%S).sqlite3

# Restore database (be careful!)
sudo cp ~/backups/db_YYYYMMDD_HHMMSS.sqlite3 \
       /home/deploy/shadcoding-task1/backend/db.sqlite3
sudo chown deploy:deploy /home/deploy/shadcoding-task1/backend/db.sqlite3
sudo systemctl restart gunicorn
```

### System Monitoring

```bash
# Check disk space
df -h

# Check memory usage
free -h

# Check CPU usage
top

# Press 'q' to exit top

# Check running processes
ps aux | grep gunicorn
ps aux | grep nginx

# Check open ports
sudo netstat -tlnp | grep :80
sudo netstat -tlnp | grep :8000

# Check server uptime
uptime
```

### Update Dependencies

```bash
# Update Python packages
sudo su - deploy
cd ~/shadcoding-task1
source venv/bin/activate
pip install --upgrade -r requirements.txt
exit

# Update frontend packages
sudo su - deploy
cd ~/shadcoding-task1/frontend
npm update
exit

# Restart services after updates
sudo systemctl restart gunicorn nginx
```

---

## üì¶ Quick Reference

### File Locations

```
/home/deploy/shadcoding-task1/              # Project root
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ .env                                 # Environment variables
‚îÇ   ‚îú‚îÄ‚îÄ db.sqlite3                          # Database
‚îÇ   ‚îî‚îÄ‚îÄ staticfiles/                        # Django static files
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îî‚îÄ‚îÄ dist/                               # Built frontend
‚îî‚îÄ‚îÄ deployment/                             # Deployment scripts

/var/www/shadcoding/frontend/               # Nginx serves from here
/etc/nginx/sites-available/shadcoding       # Nginx config
/etc/systemd/system/gunicorn.service        # Gunicorn service
/var/log/gunicorn/                          # Gunicorn logs
/var/log/nginx/                             # Nginx logs
```

### Common Command Sequences

**Deploy code changes:**
```bash
ssh ubuntu@18.217.70.110
sudo su - deploy
cd ~/shadcoding-task1
bash deployment/deploy.sh
exit
```

**Restart everything:**
```bash
sudo systemctl restart gunicorn nginx
```

**Check if everything is working:**
```bash
sudo systemctl status gunicorn nginx
curl http://18.217.70.110/api/projects/
```

**View recent errors:**
```bash
sudo journalctl -u gunicorn -n 50
sudo tail -20 /var/log/nginx/shadcoding_error.log
```

---

## üéâ Success Indicators

Your deployment is successful if:

1. ‚úÖ `sudo systemctl status gunicorn nginx` shows both active (green)
2. ‚úÖ `http://18.217.70.110` shows your Vue.js landing page
3. ‚úÖ `http://18.217.70.110/admin/` shows Django admin login
4. ‚úÖ `http://18.217.70.110/api/projects/` returns JSON
5. ‚úÖ No errors in logs: `sudo journalctl -u gunicorn -n 20`

---

## üìû Support

If you encounter issues:

1. **Check logs first** (see [Maintenance Commands](#maintenance-commands))
2. **Review troubleshooting** section above
3. **Verify .env file** has correct values
4. **Check firewall** allows HTTP traffic
5. **Restart services** as last resort

---

## üîê Security Notes

- **Change default passwords** immediately after setup
- **Keep .env file secure** - never commit to Git
- **Regular backups** - backup database before major changes
- **Monitor logs** regularly for unusual activity
- **Update packages** regularly: `sudo apt update && sudo apt upgrade`

---

**Last Updated**: 2025-01-27
**For Support**: Check deployment/README.md for additional details

---

üéâ **Happy Deploying!**
